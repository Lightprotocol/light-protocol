name: test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  check-paths:
    name: check-paths
    runs-on: buildjet-16vcpu-ubuntu-2204
    outputs:
      run_cli_relayer: ${{ steps.check-paths.outputs.run_cli_relayer }}
      run_system_programs: ${{ steps.check-paths.outputs.run_system_programs }}
      run_all: ${{ steps.check-paths.outputs.run_all }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
      - name: Check paths modified
        id: check-paths
        run: |
          echo "::set-output name=run_cli_relayer::$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^cli/|^relayer/' && echo 'true' || echo 'false')"
          echo "::set-output name=run_system_programs::$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^light-system-programs/' && echo 'true' || echo 'false')"
          echo "::set-output name=run_all::$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^light-zk.js/|^circuits/|^.github/workflows/test.yml$' && echo 'true' || echo 'false')"

  light-system-programs:
    name: light-system-programs
    if:
      github.event.pull_request.draft == false &&  (needs.check-paths.outputs.run_all == 'true' ||
      needs.check-paths.outputs.run_system_programs == 'true')
    runs-on: buildjet-16vcpu-ubuntu-2204
    needs: check-paths
    strategy:
      matrix:
        include:
          - test: system-programs-tests-transaction-user-verifiers-merkle-tree-provider
            sub-tests: '["functional", "user", "verifiers", "merkle-tree", "provider"]'
          - test: system-programs-tests-user-merge
            sub-tests: '["user-merge"]'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
      - name: Setup and build
        uses: ./.github/actions/setup-and-build
      - name: ${{ matrix.test }}
        run: |
          source ./scripts/devenv.sh
          cd light-system-programs
          IFS=', ' read -r -a sub_tests <<< "${{ join(fromJSON(matrix['sub-tests']), ', ') }}"
          for subtest in "${sub_tests[@]}"
          do
            yarn test-$subtest
          done

  light-sdk-tests:
    name: light-sdk-tests
    if: >-
      github.event.pull_request.draft == false && 
      (needs.check-paths.outputs.run_all == 'true' || 
      needs.check-paths.outputs.run_cli_relayer == 'true')
    runs-on: buildjet-16vcpu-ubuntu-2204
    needs: check-paths
    strategy:
      matrix:
        include:
          - name: sdk-tests-light-zk-light-circuits-relayer-cli
            sub-tests: '["light-zk.js", "light-circuits", "relayer", "cli"]'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
      - name: Setup and build
        uses: ./.github/actions/setup-and-build
        with:
          enable_redis: "true"
      - name: ${{ matrix.test.name }}
        run: |
          source ./scripts/devenv.sh
          IFS=', ' read -r -a sub_tests <<< "${{ join(fromJSON(matrix['sub-tests']), ', ') }}"
          for subtest in "${sub_tests[@]}"
          do
            cd $subtest
            yarn test
            cd ..
          done
