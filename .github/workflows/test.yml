on:
  push:
    branches:
      - main
    paths:
      - "light-zk.js/**/*.ts"
      - "light-system-programs/**/*.rs"
      - "light-system-programs/**/*.ts"
      - "mock-app-verifier/**/*.rs"
      - "mock-app-verifier/**/*.ts"
  pull_request:
    branches:
      - main
    paths:
      - "light-zk.js/**/*.ts"
      - "light-system-programs/**/*.rs"
      - "light-system-programs/**/*.ts"
      - "mock-app-verifier/**/*.rs"
      - "mock-app-verifier/**/*.ts"

name: test

jobs:
  functional:
    name: functional
    runs-on: buildjet-8vcpu-ubuntu-2204
    steps:
      - name: Setup and build
        uses: ./.github/actions/setup-and-build

      - name: Test
        run: |
          source ./scripts/devenv.sh
          cd light-system-programs
          yarn test-functional

  user:
    name: user
    runs-on: buildjet-8vcpu-ubuntu-2204
    steps:
      - name: Setup and build
        uses: ./.github/actions/setup-and-build

      - name: Test
        run: |
          source ./scripts/devenv.sh
          cd light-system-programs
          yarn test-user

  relayer:
    name: test
    runs-on: buildjet-8vcpu-ubuntu-2204
    steps:
      - name: Create env file
        run: |
          cd relayer
          touch .env
          echo KEY_PAIR=${{ secrets.KEY_PAIR }} > .env
          echo RELAYER_RECIPIENT=${{ secrets.RELAYER_RECIPIENT }} >> .env
          echo LOOK_UP_TABLE=${{ secrets.LOOK_UP_TABLE }} >> .env
          echo TEST_ENVIROMENT=${{ secrets.TEST_ENVIROMENT }} >> .env

      - name: Setup and build
        uses: ./.github/actions/setup-and-build

      - name: Test relayer
        run: |
          source ./scripts/devenv.sh
          cd relayer
          yarn test