name: 'Setup with Nix'
description: 'Install Nix and prepare devshell for Light Protocol'

inputs:
  skip-devshell-build:
    description: 'Skip building the devshell (for faster startup when only nix tools needed)'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Cache Nix store
      uses: actions/cache@v4
      with:
        path: |
          /nix/store
          /nix/var/nix/profiles
          ~/.cache/nix
        key: nix-${{ runner.os }}-${{ hashFiles('nix/devenv/flake.lock', 'nix/devenv/*.nix') }}
        restore-keys: |
          nix-${{ runner.os }}-

    - name: Build devshell
      if: inputs.skip-devshell-build != 'true'
      shell: bash
      run: |
        # Build and cache the devshell
        nix develop ./nix/devenv --command echo "Devshell ready"

    - name: Set environment
      shell: bash
      run: |
        echo "IN_NIX_SHELL=true" >> $GITHUB_ENV
