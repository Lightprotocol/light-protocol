# Macro Architecture Overview

## Summary

| Macro | Level | Purpose |
|-------|-------|---------|
| LightAccount | Data struct | Generates packed struct + traits for account data |
| LightAccounts | Accounts struct | Generates variant structs + lifecycle hooks |
| light_program | Program module | Collects variants into enum + generates instructions |

---

## Account Types

| Type | Data Struct | Variant Struct | Generated By |
|------|-------------|----------------|--------------|
| Pda | User-defined | Generated | LightAccounts |
| PdaZeroCopy | User-defined | Generated | LightAccounts |
| Token | TokenData (SDK) | SDK generic | LightAccounts (seeds only) |
| Ata | TokenData (SDK) | SDK generic | LightAccounts (seeds only) |
| Mint | MintData (SDK) | SDK generic | LightAccounts (seeds only) |

---

## Trait Hierarchy

| Trait | Applied To | Purpose |
|-------|------------|---------|
| LightAccount | Data structs | Hash, pack/unpack, discriminator |
| LightAccountVariant | Variant structs | Seeds, data, PDA derivation |
| PackedLightAccountVariant | Packed variants | Bump, unpack |
| LightPreInit | Accounts structs | Pre-initialization lifecycle hook |
| LightFinalize | Accounts structs | Finalization lifecycle hook (noop) |

---

## Generated Items

### LightAccount generates:
- Packed struct (Pubkeys to indices)
- LightAccount trait implementation

### LightAccounts generates:
- Seeds structs (unpacked and packed)
- Variant structs (unpacked and packed)
- LightAccountVariant trait implementation
- LightPreInit / LightFinalize trait implementations

### light_program generates:
- Program-wide variant enum (collects all variants)
- Packed variant enum
- compress_and_close instruction
- decompress_idempotent instruction
- Config instructions (initialize, update)
- Auto-wrapped handlers with lifecycle hooks

---

## SDK Functions

| Function | Purpose |
|----------|---------|
| light_pre_init_pda | Returns CompressedAccountInfo for a PDA |
| light_init_pdas | Batch init all PDAs with proof |
| light_pre_init_mint | CPI to create compressed mint |
| light_pre_init_token | CPI to create compressed token account |
| light_pre_init_ata | CPI to create compressed ATA |
| light_decompress_mints | CPI to decompress all mints |
| compress_and_close | Close PDA, insert into Merkle tree |
| decompress_idempotent | Recreate PDA from Merkle tree |

---

## Key Design Principles

1. **Separation of concerns** - Each macro has a single responsibility
2. **SDK does heavy lifting** - Macros generate types, SDK contains logic
3. **Delegate to inner types** - Enum delegates to individual variant implementations
4. **Unique field names** - Enforced across entire program
5. **Pre-implemented SDK types** - Token/ATA/Mint use SDK generics

---

## Documentation

| File | Content |
|------|---------|
| light_account.md | LightAccount derive macro spec |
| light_accounts.md | LightAccounts derive macro spec |
| light_program.md | light_program attribute macro spec |
