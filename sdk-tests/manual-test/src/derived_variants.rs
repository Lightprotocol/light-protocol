//! Program-wide variant enums for compress/decompress dispatch.
//!
//! This module contains the code that would be generated by the `#[light_program]` macro.

use anchor_lang::prelude::*;
use light_sdk_types::instruction::account_meta::CompressedAccountMetaNoLamportsNoAddress;
use solana_program_error::ProgramError;

use crate::account_loader::derived_accounts::PackedZeroCopyRecordVariant;
use crate::account_loader::ZeroCopyRecordVariant;
use crate::all::derived_accounts::{
    AllBorshVariant, AllZeroCopyVariant, PackedAllBorshVariant, PackedAllZeroCopyVariant,
};
use crate::pda::derived_accounts::{MinimalRecordVariant, PackedMinimalRecordVariant};
use light_sdk::interface::{prepare_account_for_decompression, DecompressCtx, DecompressVariant};

// ============================================================================
// Program-wide Variant Enums (generated by #[light_program])
// ============================================================================

/// Unpacked variant enum for all account types in this program.
/// Each variant contains the full seeds + data.
#[derive(AnchorSerialize, AnchorDeserialize, Clone, Debug)]
pub enum LightAccountVariant {
    MinimalRecord(MinimalRecordVariant),
    ZeroCopyRecord(ZeroCopyRecordVariant),
    AllBorsh(AllBorshVariant),
    AllZeroCopy(AllZeroCopyVariant),
}

/// Packed variant enum for efficient serialization.
/// Does NOT wrap CompressedAccountData - that wrapper is added by the client library.
#[derive(AnchorSerialize, AnchorDeserialize, Clone, Debug)]
pub enum PackedLightAccountVariant {
    MinimalRecord(PackedMinimalRecordVariant),
    ZeroCopyRecord(PackedZeroCopyRecordVariant),
    AllBorsh(PackedAllBorshVariant),
    AllZeroCopy(PackedAllZeroCopyVariant),
}

// ============================================================================
// DecompressVariant Implementation (MACRO-GENERATED)
// ============================================================================

/// Implementation for PackedLightAccountVariant.
/// Implements on the inner variant type to satisfy orphan rules.
impl<'info> DecompressVariant<'info> for PackedLightAccountVariant {
    fn decompress(
        &self,
        meta: &CompressedAccountMetaNoLamportsNoAddress,
        pda_account: &AccountInfo<'info>,
        ctx: &mut DecompressCtx<'_, 'info>,
    ) -> std::result::Result<(), ProgramError> {
        match self {
            PackedLightAccountVariant::MinimalRecord(packed_data) => {
                prepare_account_for_decompression::<4, PackedMinimalRecordVariant>(
                    packed_data,
                    meta,
                    pda_account,
                    ctx,
                )
            }
            PackedLightAccountVariant::ZeroCopyRecord(packed_data) => {
                prepare_account_for_decompression::<4, PackedZeroCopyRecordVariant>(
                    packed_data,
                    meta,
                    pda_account,
                    ctx,
                )
            }
            PackedLightAccountVariant::AllBorsh(packed_data) => {
                prepare_account_for_decompression::<3, PackedAllBorshVariant>(
                    packed_data,
                    meta,
                    pda_account,
                    ctx,
                )
            }
            PackedLightAccountVariant::AllZeroCopy(packed_data) => {
                prepare_account_for_decompression::<3, PackedAllZeroCopyVariant>(
                    packed_data,
                    meta,
                    pda_account,
                    ctx,
                )
            }
        }
    }
}
