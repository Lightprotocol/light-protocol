Implement the following plan:

# Plan: Add Frozen + InsufficientFunds Checks to CToken Self-Transfer

**Date:** 2026-02-16
**Issue:** https://github.REDACTED

## IMPORTANT
- Split into todos, work through one by one
- If stuck, use subagent to research

## Context

The self-transfer fix (commit 8835b72) added early return in `process_ctoken_transfer` and `process_ctoken_transfer_checked` when `source == destination`. This bypasses pinocchio's `process_transfer` which normally validates:

1. **Frozen**: `source_account.is_frozen()` -> AccountFrozen (pinocchio shared/transfer.rs:82)
2. **InsufficientFunds**: `source_account.amount.checked_sub(amount)` -> InsufficientFunds (pinocchio shared/transfer.rs:86-89)
3. **MintMismatch**: Not applicable for self-transfer (same account)

Currently `validate_self_transfer` (`shared.rs:23-33`) only checks authority (signer + owner/delegate). A frozen account self-transfer succeeds. A self-transfer with `amount > balance` succeeds.

## Task 1: Add frozen and insufficient funds checks to validate_self_transfer

**File:** `programs/compressed-token/program/src/ctoken/transfer/shared.rs`

Modify `validate_self_transfer` to accept the transfer amount and check both conditions. The token account is already deserialized in `validate_self_transfer_authority` (line 43-44).

**Change `validate_self_transfer` signature** to accept amount:
```rust
pub fn validate_self_transfer(
    source: &AccountInfo,
    destination: &AccountInfo,
    authority: &AccountInfo,
    amount: u64,
) -> Result<bool, ProgramError>
```

**Pass amount through to `validate_self_transfer_authority`** and add checks after deserializing the token (line 44), before the owner/delegate check:
```rust
fn validate_self_transfer_authority(
    source: &AccountInfo,
    authority: &AccountInfo,
    amount: u64,
) -> Result<(), ProgramError> {
    if !authority.is_signer() {
        return Err(ProgramError::MissingRequiredSignature);
    }
    let token =
        Token::from_account_info_checked(source).map_err(|_| ProgramError::InvalidAccountData)?;
    if token.base.is_frozen() {
        return Err(ErrorCode::AccountFrozen.into());
    }
    if token.base.amount.get() < amount {
        return Err(ErrorCode::InsufficientFunds.into());
    }
    // ... existing owner/delegate check ...
}
```

- `token.base.is_frozen()` -- method on `ZTokenZeroCopyMeta` (zero_copy.rs:369), checks state == 2
- `token.base.amount.get()` -- returns `u64` from zero-copy wrapper
- `ErrorCode::AccountFrozen` and `ErrorCode::InsufficientFunds` already defined in anchor crate

## Task 2: Update callers to pass amount

**File:** `programs/compressed-token/program/src/ctoken/transfer/default.rs`

Parse amount from instruction_data before the self-transfer check:
```rust
let amount = u64::from_le_bytes(instruction_data[..8].try_into().map_err(|_| ProgramError::InvalidInstructionData)?);
if validate_self_transfer(source, destination, &accounts[ACCOUNT_AUTHORITY], amount)? {
    return Ok(());
}
```

**File:** `programs/compressed-token/program/src/ctoken/transfer/checked.rs`

Same pattern -- parse amount from instruction_data[..8] before self-transfer check:
```rust
let amount = u64::from_le_bytes(instruction_data[..8].try_into().map_err(|_| ProgramError::InvalidInstructionData)?);
if validate_self_transfer(source, destination, &accounts[ACCOUNT_AUTHORITY], amount)? {
    return Ok(());
}
```

## Task 3: Add tests

Add tests verifying:
1. Frozen CToken account self-transfer returns AccountFrozen
2. Self-transfer with amount > balance returns InsufficientFunds
3. Normal self-transfer (unfrozen, sufficient balance) still succeeds

Location: existing test file or new test in `program-tests/compressed-token-test/`

## Files to Modify
1. `programs/compressed-token/program/src/ctoken/transfer/shared.rs` -- add frozen + insufficient funds checks
2. `programs/compressed-token/program/src/ctoken/transfer/default.rs` -- pass amount to validate_self_transfer
3. `programs/compressed-token/program/src/ctoken/transfer/checked.rs` -- pass amount to validate_self_transfer

## Verification
1. `cargo check -p light-compressed-token-program`
2. `cargo test-sbf -p compressed-token-test` -- verify no regressions
3. New tests pass for frozen and insufficient funds self-transfer rejection


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/ananas/.REDACTED.jsonl